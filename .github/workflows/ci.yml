name: TestRail Automation CI
 
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      caseId:
        description: "TestRail caseId to run (e.g., 40)"
        required: false
        default: "40"
 
jobs:
  tests:
    runs-on: ubuntu-latest
    env:
      # If run manually, use the input; for push/PR, default to 40
      TESTRAIL_CASE_ID: ${{ github.event.inputs.caseId || '40' }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
 
      - name: â˜• Setup Temurin JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: maven
 
      - name: ğŸ”§ Show environment
        run: |
          echo "Branch: ${{ github.ref }}"
          echo "Event:  ${{ github.event_name }}"
          java -version
          mvn -version
          echo "Selected TestRail caseId: $TESTRAIL_CASE_ID"
 
      - name: ğŸ“¦ Build (skip tests)
        run: mvn -B -ntp clean install -DskipTests
 
      - name: ğŸŒ Install Chrome
        # Stable, fast install compared to apt
        uses: browser-actions/setup-chrome@v1
 
      - name: ğŸ” Verify Chrome
        run: |
          (chrome --version || google-chrome --version)
          (which chrome || which google-chrome)
 
      - name: ğŸ§ª Run TestNG (Chrome headless) for case ${{ env.TESTRAIL_CASE_ID }}
        # If your framework uses a different prop key, change -Dtestrail.caseId=...
        run: |
          mvn -B -ntp test \
            -Dbrowser=chrome \
            -Dheadless=true \
            -Dtestrail.caseId=${{ env.TESTRAIL_CASE_ID }}
        continue-on-error: true
 
      - name: ğŸ“Š Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            test-output/**
            **/test-output/**
            target/surefire-reports/**
          retention-days: 30
 
      - name: ğŸ“„ Upload Extent Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: extent-report
          path: |
            test-output/ExtentReport.html
            **/ExtentReport.html
          retention-days: 30
 
      - name: ğŸ“¸ Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: |
            test-output/screenshots/**
            **/screenshots/**
            target/screenshots/**
          retention-days: 30
 
  summary:
    runs-on: ubuntu-latest
    needs: [tests]
    if: always()
    steps:
      - name: âœ… Summary
        run: |
          echo "=========================================="
          echo "TEST EXECUTION COMPLETED"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "=========================================="
          echo "Artifacts contain reports, extent report & screenshots."
          echo "=========================================="
