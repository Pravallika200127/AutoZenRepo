name: TestRail Automation CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  # ========================================
  # Single Browser Execution (Recommended)
  # ========================================
  test-single-browser:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: â˜• Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ”§ Display configuration
      run: |
        echo "==================================="
        echo "CI Environment Configuration"
        echo "==================================="
        echo "Java Version: $(java -version)"
        echo "Maven Version: $(mvn -version)"
        echo "Branch: ${{ github.ref }}"
        echo "==================================="
    
    - name: ğŸ“¦ Install dependencies
      run: mvn clean install -DskipTests
    
    - name: ğŸŒ Install Chrome browser
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    - name: ğŸ” Verify Chrome installation
      run: |
        google-chrome --version
        which google-chrome
    
    - name: ğŸ§ª Run tests with Chrome (headless)
      run: mvn test -Dbrowser=chrome -Dheadless=true
      continue-on-error: true
    
    - name: ğŸ“Š Upload test reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-reports-chrome
        path: |
          test-output/**
          reports/**
          target/surefire-reports/**
        retention-days: 30
    
    - name: ğŸ“„ Upload Extent Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: extent-report-chrome
        path: test-output/ExtentReport.html
        retention-days: 30
    
    - name: ğŸ“¸ Upload Screenshots
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: screenshots-chrome
        path: test-output/screenshots/**
        retention-days: 30

  # ========================================
  # Multi-Browser Matrix (Optional - Enable if needed)
  # ========================================
  test-multi-browser:
    runs-on: ubuntu-latest
    if: false  # Set to true to enable multi-browser testing
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chrome, firefox]
        include:
          - browser: chrome
            browser-display: "Google Chrome"
          - browser: firefox
            browser-display: "Mozilla Firefox"
    
    name: Test on ${{ matrix.browser-display }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: â˜• Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸŒ Install browsers
      run: |
        if [ "${{ matrix.browser }}" == "chrome" ]; then
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          google-chrome --version
        elif [ "${{ matrix.browser }}" == "firefox" ]; then
          sudo apt-get update
          sudo apt-get install -y firefox
          firefox --version
        fi
    
    - name: ğŸ“¦ Install dependencies
      run: mvn clean install -DskipTests
    
    - name: ğŸ§ª Run tests - ${{ matrix.browser-display }}
      run: |
        echo "=========================================="
        echo "Running tests on ${{ matrix.browser-display }}"
        echo "Browser: ${{ matrix.browser }}"
        echo "Headless: true"
        echo "=========================================="
        mvn test -Dbrowser=${{ matrix.browser }} -Dheadless=true
      continue-on-error: true
    
    - name: ğŸ“Š Upload test reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-reports-${{ matrix.browser }}
        path: |
          test-output/**
          reports/**
          target/surefire-reports/**
        retention-days: 30

  # ========================================
  # Label-Based Execution (Smoke/Regression)
  # ========================================
  test-by-labels:
    runs-on: ubuntu-latest
    if: false  # Set to true to enable label-based testing
    
    strategy:
      fail-fast: false
      matrix:
        test-suite: [Smoke, Regression]
    
    name: Run ${{ matrix.test-suite }} Tests
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: â˜• Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸŒ Install Chrome browser
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        google-chrome --version
    
    - name: ğŸ“¦ Install dependencies
      run: mvn clean install -DskipTests
    
    - name: ğŸ§ª Run ${{ matrix.test-suite }} tests
      run: |
        echo "=========================================="
        echo "Running ${{ matrix.test-suite }} Test Suite"
        echo "=========================================="
        mvn test -Dbrowser=chrome -Dheadless=true -Dtestrail.labels=${{ matrix.test-suite }}
      continue-on-error: true
    
    - name: ğŸ“Š Upload test reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-reports-${{ matrix.test-suite }}
        path: |
          test-output/**
          reports/**
        retention-days: 30

  # ========================================
  # Test Summary and Notification
  # ========================================
  test-summary:
    runs-on: ubuntu-latest
    needs: [test-single-browser]
    if: always()
    
    steps:
    - name: ğŸ“Š Test Execution Summary
      run: |
        echo "=========================================="
        echo "TEST EXECUTION COMPLETED"
        echo "=========================================="
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo "Triggered by: ${{ github.event_name }}"
        echo "=========================================="
        echo "Check artifacts for detailed reports"
        echo "=========================================="
