name: CI AutoZen Pipeline (Single TestRail Case)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      case_id:
        description: "TestRail Case ID (e.g., 40 or C40)"
        required: true
        default: "40"

jobs:
  test:
    name: Test on ${{ matrix.browser }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - browser: chrome
            os: ubuntu-latest
          - browser: firefox
            os: ubuntu-latest
          - browser: edge
            os: ubuntu-latest

    env:
      HEADLESS: "true"

      # ---- Static TestRail details ----
      TESTRAIL_URL: "https://newzen01.testrail.io/"
      TESTRAIL_USER: "2021hx70001@wilp.bits-pilani.ac.in"
      TESTRAIL_API_KEY: "Xwuv6cXNPrvCd6Q4YrnJ-pgmm6/QWk0qwetKvl9NP"
      TESTRAIL_PROJECT_ID: "3"
      TESTRAIL_SUITE_ID: "7"
      TESTRAIL_LABELS: "Autozen_TestSuite"
      TESTRAIL_ENABLED: "true"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven Packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      # ---------- Chrome ----------
      - name: Setup Chrome
        if: matrix.browser == 'chrome'
        uses: browser-actions/setup-chrome@v1

      # ---------- Firefox ----------
      - name: Setup Firefox
        if: matrix.browser == 'firefox'
        uses: browser-actions/setup-firefox@v1

      # ---------- Edge ----------
      - name: Setup Microsoft Edge
        if: matrix.browser == 'edge'
        shell: bash
        run: |
          echo "ðŸŸ¦ Installing Microsoft Edge..."
          sudo apt-get update -qq
          sudo apt-get install -y curl unzip gpg apt-transport-https wget
          curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | sudo gpg --dearmor -o /usr/share/keyrings/microsoft.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/edge stable main" | sudo tee /etc/apt/sources.list.d/microsoft-edge.list > /dev/null
          sudo apt-get update -qq
          sudo apt-get install -y microsoft-edge-stable
          EDGE_VERSION=$(microsoft-edge-stable --version || true)
          echo "âœ… Edge version: $EDGE_VERSION"

      # ---------- Display Versions ----------
      - name: Display Browser Versions
        run: |
          echo "ðŸŒ Browser: ${{ matrix.browser }}"
          case "${{ matrix.browser }}" in
            chrome)
              google-chrome --version || google-chrome-stable --version
              ;;
            firefox)
              firefox --version
              ;;
            edge)
              microsoft-edge-stable --version
              ;;
          esac

      # ---------- Generate config.properties ----------
      - name: Generate config.properties
        run: |
          mkdir -p src/test/resources
          cat > src/test/resources/config.properties <<CFG
          # ====== Auto-generated for CI ======
          browser=${{ matrix.browser }}
          headless=${HEADLESS}

          # ---- TestRail ----
          testrail.enabled=${TESTRAIL_ENABLED}
          testrail.url=${TESTRAIL_URL}
          testrail.user=${TESTRAIL_USER}
          testrail.apiKey=${TESTRAIL_API_KEY}
          testrail.projectId=${TESTRAIL_PROJECT_ID}
          testrail.suiteId=${TESTRAIL_SUITE_ID}
          testrail.labels=${TESTRAIL_LABELS}
          testrail.caseId=${{ github.event.inputs.case_id }}
          CFG

          echo "âœ… Generated src/test/resources/config.properties"
          sed -E 's/(apiKey) *= *.*/\1=********/Ig' src/test/resources/config.properties

      # ---------- Build ----------
      - name: Build (no tests)
        run: mvn -B -q -DskipTests clean package

      # ---------- Run TestRunner ----------
      - name: Run TestRunner (Case ${{ github.event.inputs.case_id }})
        run: |
          mvn -B test \
            -Dheadless=${HEADLESS} \
            -Dbrowser=${{ matrix.browser }} \
            -Dtest=TestRunner
        env:
          _JAVA_OPTIONS: -Xmx1024m
          MAVEN_OPTS: -Xmx1024m

      # ---------- Upload Reports ----------
      - name: Upload Reports (${{ matrix.browser }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ matrix.browser }}
          path: |
            reports/**
            test-output/**
            **/surefire-reports/**
            **/failsafe-reports/**
          if-no-files-found: ignore
          retention-days: 30

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "ðŸŽ¯ Tests finished for case ${{ github.event.inputs.case_id }}"
          if [ "${{ needs.test.result }}" = "failure" ]; then
            echo "âŒ Some browser runs failed. Check artifacts."
            exit 1
          else
            echo "âœ… All browser runs passed."
          fi
